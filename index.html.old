<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shaviyani Health Directory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Bootstrap 5 CSS CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  
  <style>
    body {
      background-color: #f7f9fc;
      color: #333;
      padding: 20px;
      min-height: 100vh;
    }
    h1 {
      color: #1a5fb4;
      margin-bottom: 30px;
      text-align: center;
      font-weight: 600;
    }
    .center-group {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 40px;
      padding: 20px;
    }
    .center-group h2 {
      color: #1a5fb4;
      border-bottom: 2px solid #ddd;
      padding-bottom: 8px;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      font-size: 0.95rem;
      user-select: none; /* prevent text selection on header click */
    }
    th, td {
      cursor: pointer; /* indicate headers are clickable */
    }
    th {
      background-color: #f0f4fa;
      font-weight: 600;
      position: relative;
    }
    th .sort-arrow {
      font-size: 0.7rem;
      margin-left: 5px;
      user-select: none;
    }
    td a {
      text-decoration: none;
    }
    td a:hover {
      text-decoration: underline;
    }
    .no-results {
      color: #666;
      font-style: italic;
      text-align: center;
      margin-top: 30px;
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>Shaviyani Health Directory</h1>

    <div class="mb-4">
      <input
        type="search"
        class="form-control form-control-lg"
        id="searchInput"
        placeholder="🔍 Search by any field..."
        autocomplete="off"
      />
    </div>

    <div id="directoryContainer">
      <p class="no-results">Loading data…</p>
    </div>
  </div>

  <!-- Bootstrap 5 JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwndImcPMsQCTx1xLtxolE7Q7nOdN_nVpmOh7fw0U0Sy0-0u30Chp6ovUVhJgk2XdRuNg/exec';

    function normalize(str) {
      return (str || '').toString().toLowerCase().replace(/\s+/g, ' ').trim();
    }

    let allRows = [];

    async function loadData() {
      const container = document.getElementById('directoryContainer');
      try {
        const res = await fetch(WEB_APP_URL);
        if (!res.ok) throw new Error(`HTTP error ${res.status}`);

        const data = await res.json();

        if (!Array.isArray(data) || data.length === 0) {
          container.innerHTML = '<p class="no-results">No data found.</p>';
          return;
        }

        container.innerHTML = '';

        const grouped = {};
        data.forEach(item => {
          const center = String(item['Health Center'] || 'Unknown').trim();
          if (!grouped[center]) grouped[center] = [];
          grouped[center].push(item);
        });

        for (const center in grouped) {
          const section = document.createElement('section');
          section.className = 'center-group';
          section.dataset.center = center.toLowerCase();

          const rowsHtml = grouped[center].map(person => {
            const fullName = String(person['Assigned To'] || '').trim();
            const role = String(person['Role  or Function'] || '').trim();
            const dept = String(person['Department'] || '').trim();
            const phoneRaw = person['Contact Number'] || '';
            const phone = String(phoneRaw).trim();

            const searchText = normalize(`${center} ${fullName} ${role} ${dept} ${phone}`);

            return `
              <tr class="data-row" data-search="${searchText}">
                <td><a href="tel:${phone}" class="text-decoration-none">📞 ${phone}</a></td>
                <td>${dept}</td>
                <td>${fullName}</td>
                <td>${role}</td>
              </tr>`;
          }).join('');

          section.innerHTML = `
            <h2>${center}</h2>
            <div class="table-responsive">
              <table class="table table-striped table-hover sortable-table">
                <thead class="table-light">
                  <tr>
                    <th data-col="0">Phone <span class="sort-arrow"></span></th>
                    <th data-col="1">Department <span class="sort-arrow"></span></th>
                    <th data-col="2">Assigned To <span class="sort-arrow"></span></th>
                    <th data-col="3">Role or Function <span class="sort-arrow"></span></th>
                  </tr>
                </thead>
                <tbody>
                  ${rowsHtml}
                </tbody>
              </table>
            </div>
          `;

          container.appendChild(section);
        }

        allRows = Array.from(document.querySelectorAll('.data-row'));

        enableSorting();

      } catch (error) {
        container.innerHTML = `<p class="no-results">Failed to load data: ${error.message}</p>`;
        console.error(error);
      }
    }

    function filterData() {
      const term = normalize(document.getElementById('searchInput').value);
      if (!term) {
        allRows.forEach(row => (row.style.display = ''));
        document.querySelectorAll('section.center-group').forEach(s => (s.style.display = ''));
        const msg = document.querySelector('.no-results-message');
        if (msg) msg.remove();
        return;
      }

      let anyVisible = false;

      allRows.forEach(row => {
        const match = row.dataset.search.includes(term);
        row.style.display = match ? '' : 'none';
        if (match) anyVisible = true;
      });

      document.querySelectorAll('section.center-group').forEach(section => {
        const visibleRows = section.querySelectorAll('tbody tr:not([style*="display: none"])');
        section.style.display = visibleRows.length ? '' : 'none';
      });

      const container = document.getElementById('directoryContainer');
      if (!anyVisible && !document.querySelector('.no-results-message')) {
        const msg = document.createElement('p');
        msg.className = 'no-results no-results-message';
        msg.textContent = 'No matching contacts found.';
        container.appendChild(msg);
      } else if (anyVisible) {
        const msg = document.querySelector('.no-results-message');
        if (msg) msg.remove();
      }
    }

    function enableSorting() {
      const tables = document.querySelectorAll('table.sortable-table');
      tables.forEach(table => {
        const headers = table.querySelectorAll('thead th');
        headers.forEach(th => {
          th.addEventListener('click', () => {
            const colIndex = parseInt(th.getAttribute('data-col'));
            const tbody = table.querySelector('tbody');
            const rowsArray = Array.from(tbody.querySelectorAll('tr'));

            // Determine current sort direction
            let currentSort = th.getAttribute('data-sort') || 'none';
            // Reset sort on other headers
            headers.forEach(h => {
              if (h !== th) {
                h.setAttribute('data-sort', 'none');
                h.querySelector('.sort-arrow').textContent = '';
              }
            });

            // Toggle sort direction
            let newSort;
            if (currentSort === 'none' || currentSort === 'desc') newSort = 'asc';
            else newSort = 'desc';

            th.setAttribute('data-sort', newSort);
            th.querySelector('.sort-arrow').textContent = newSort === 'asc' ? '▲' : '▼';

            rowsArray.sort((a, b) => {
              let aText = a.children[colIndex].textContent.trim().toLowerCase();
              let bText = b.children[colIndex].textContent.trim().toLowerCase();

              // Special case: phone column (col 0) — compare numerically ignoring non-digits
              if (colIndex === 0) {
                aText = aText.replace(/\D/g, '') || '0';
                bText = bText.replace(/\D/g, '') || '0';
                return newSort === 'asc' ? aText.localeCompare(bText, undefined, {numeric: true}) : bText.localeCompare(aText, undefined, {numeric: true});
              }

              // Default string comparison
              if (aText < bText) return newSort === 'asc' ? -1 : 1;
              if (aText > bText) return newSort === 'asc' ? 1 : -1;
              return 0;
            });

            // Append sorted rows
            rowsArray.forEach(row => tbody.appendChild(row));
          });
        });
      });
    }

    document.getElementById('searchInput').addEventListener('input', filterData);

    window.onload = loadData;
  </script>
</body>
</html>



